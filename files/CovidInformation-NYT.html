<!doctype HTML>
<head>
<style>

.rectangle {
	fill: steelblue;
}
.rectangle:hover {
	fill: orange;
}
.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
</style>

<script src="https://d3js.org/d3.v5.min.js"></script>

<h2> COVID-19 Cases and Deaths by County </h2>

</head>
<body>

The data is taken directly from the <a href="https://github.com/nytimes/covid-19-data">New York Times COVID-19 Dataset</a>.

<hr>

<div id="location" align="center">
	<select id="state" class="dropdown"></select>
	<select id="county" class="dropdown"></select>
</div>

<div id="facts" align="center">
	<div id="first"></div>
	<div id="totalcases"></div>
	<div id="totaldeaths"></div>
</div>

<div id="checkboxes" align="center">
	<input type="checkbox" id="cumulativecases"> Show cumulative cases <br>
	<input type="checkbox" id="dailycases"> Show cumulative cases <br>
	<input type="checkbox" id="cumulativedeaths"> Show cumulative deaths <br>
	<input type="checkbox" id="dailydeaths"> Show cumulative deaths <br>
</div>

<script>
d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv").then( function(d) {
//d3.csv("us-counties.csv", function(d) {
	function dispGraphs()
	{
		// Collect Information
		my_state = document.getElementById("state");
		my_county = document.getElementById("county");

		var sel_state = my_state.value;
		var sel_county = my_county.value;

		var state_index = states.indexOf( sel_state );
		var counties = counties_by_state[state_index];

		// Get county level data
		var state_data = all_data.filter( function(d) { return (d.state == sel_state) ; } )
		var county_data = state_data.filter( function(d) { return (d.county == sel_county) ; } );
		county_data.sort((a,b) => d3.ascending(a.date, b.date));

		// Change fact box
		var firstdate = new Date(d3.min( county_data, d => d.date ));
		d3.select("#first").text( "First case: " + firstdate.toLocaleDateString() );
		d3.select("#totalcases").text( "Total cases: " + d3.max( county_data, d => +d.cases) );
		d3.select("#totaldeaths").text( "Total deaths: " + d3.max( county_data, d => +d.deaths) );

		x.domain([ new Date(d3.min( county_data, d => d.date )), new Date(d3.max( county_data, d => d.date)) ]);
		y.domain([ 0,	 d3.max( county_data, d => +d.cases) ]);
		d3.select("#x_axis").call(xAxis);
		d3.select("#y_axis").call(yAxis);

		new_cases = [ { "date": county_data[0].date, "new_cases": county_data[0].cases } ];
		for (i = 1 ; i < county_data.length - 1 ; i++)
		{
			new_cases.push( {"date": county_data[i].date, "new_cases": county_data[i].cases - county_data[i-1].cases })
		}

		new_deaths = [ { "date": county_data[0].date, "new_deaths": county_data[0].deaths } ];
		for (i = 1 ; i < county_data.length - 1 ; i++)
		{
			new_deaths.push( {"date": county_data[i].date, "new_deaths": county_data[i].deaths - county_data[i-1].deaths })
		}

		// Add the paths
		svg.select("#deaths")
			.datum(county_data)
			.attr("d", d3.line()
				.x( function(d) { return x(new Date(d.date) ); })
				.y( function(d) { return y( +d.deaths ); }))

		svg.select("#cases")
			.datum(county_data)
			.attr("d", d3.line()
				.x( function(d) { return x(new Date(d.date) ); })
				.y( function(d) { return y( +d.cases ); }))

		svg.select("#new_cases")
			.datum(new_cases)
			.attr("d", d3.line()
				.x( function(d) { return x(new Date(d.date) ); })
				.y( function(d) { return y( +d.new_cases ); })) ;

		svg.select("#new_deaths")
			.datum(new_deaths)
			.attr("d", d3.line()
				.x( function(d) { return x(new Date(d.date) ); })
				.y( function(d) { return y( +d.new_deaths ); })) ;
	}
	// Preserve the data by naming it
	var all_data = d;

	// Set up display variables
	var width = 1000;
	var height = 500;
	var margin = { left: 50, right: 50, top: 50, bottom: 100 };

	var disp_height = height - margin.top - margin.bottom;
	var disp_width = width - margin.left - margin.right;

	// Set up SVG canvas
	var x = d3.scaleTime()
		.domain([ new Date("2020-01-01"), new Date("2020-05-29")])
		.range([0, disp_width]);

	var y = d3.scaleLinear()
		.domain( [0, 1000] )
		.range([disp_height,0]);

	var xAxis = d3.axisBottom(x);

	var yAxis = d3.axisLeft(y);

	// Set up svg
	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")" );

	// Draw x and y axes
	svg.append("g")
		.attr("id", "x_axis")
		.attr("class", "axis")
		.attr("transform", "translate(0," + disp_height + ")")
		.call(xAxis)
		.selectAll("text")
		.style("font-size", "8px")
		.style("text-anchor", "end")
		.attr("dx", "-.8em")
		.attr("dy", "-.55em")
		.attr("transform", "rotate(-90)" );

 	svg.append("g")
		.attr("id", "y_axis")
	    	.attr("class", "axis")
    		.call(yAxis);

	// Set up drop-down menus
	var states = d3.map( d , function (d) { return d.state ; } ).keys().sort(d3.ascending);

	var counties_by_state = [];
	for ( i = 0; i < states.length; i++ )
	{
		counties_by_state.push( d3.map( d.filter( function(d) { return d.state == states[i] } ), function(d) {return d.county} ).keys().sort( d3.ascending ) );
	}

	d3.select("#state").selectAll("option")
		.data(states)
		.enter()
		.append("option")
		.attr("id", function(d) { return d ; } )
		.attr("value", function(d) { return d ; } )
		.text( function(d) { return d ; } )
		.property("selected", function(d) { return d == "Nevada"});

	counties = counties_by_state[ states.indexOf( "Nevada") ];

	d3.select("#county").selectAll("option")
		.data(counties)
		.enter()
		.append("option")
		.attr("value", function(d) { return d; } )
		.text( function(d) { return d; } )
		.property("selected", function(d) { return d == "Clark"});

	// Draw Initial Graph
	var state_data = all_data.filter( function(d) { return (d.state == "Nevada") ; } )
	var county_data = state_data.filter( function(d) { return (d.county == "Clark") ; } );
	county_data.sort((a,b) => d3.ascending(a.date, b.date));

	// Calculate new cases and new deaths
	new_cases = [ { "date": county_data[0].date, "new_cases": county_data[0].cases } ];
	for (i = 1 ; i < county_data.length - 1 ; i++)
	{
		new_cases.push( {"date": county_data[i].date, "new_cases": county_data[i].cases - county_data[i-1].cases })
	}

	new_deaths = [ { "date": county_data[0].date, "new_deaths": county_data[0].deaths } ];
	for (i = 1 ; i < county_data.length - 1 ; i++)
	{
		new_deaths.push( {"date": county_data[i].date, "new_deaths": county_data[i].deaths - county_data[i-1].deaths })
	}

	x.domain([ new Date(d3.min( county_data, d => d.date )), new Date(d3.max( county_data, d => d.date)) ]);
	y.domain([ 0,	 d3.max( county_data, d => +d.cases) ]);
  d3.select("#x_axis").call(xAxis);
	d3.select("#y_axis").call(yAxis);

	var firstdate = new Date(d3.min( county_data, d => d.date ));
	d3.select("#first").text( "First case: " + firstdate.toLocaleDateString() );
	d3.select("#totalcases").text( "Total cases: " + d3.max( county_data, d => +d.cases) );
	d3.select("#totaldeaths").text( "Total deaths: " + d3.max( county_data, d => +d.deaths) );

	svg.append("path")
		.datum(county_data)
		.attr("id", "deaths")
		.attr("fill", "none")
		.attr("stroke", "steelblue")
		.attr("stroke-width", 1)
		.attr("d", d3.line()
			.x( function(d) { return x( new Date(d.date)) ; })
			.y( function(d) { return y( +d.deaths ); })) ;

	svg.append("path")
		.datum(county_data)
		.attr("id", "cases")
		.attr("fill", "none")
		.attr("stroke", "steelblue")
		.attr("stroke-width", 1)
		.attr("d", d3.line()
			.x( function(d) { return x(new Date(d.date) ); })
			.y( function(d) { return y( +d.cases ); })) ;

	svg.append("path")
		.datum(new_cases)
		.attr("id", "new_cases")
		.attr("fill", "none")
		.attr("stroke", "steelblue")
		.attr("stroke-width", 1)
		.attr("d", d3.line()
			.x( function(d) { return x(new Date(d.date) ); })
			.y( function(d) { return y( +d.new_cases ); })) ;


	svg.append("path")
		.datum(new_deaths)
		.attr("id", "new_deaths")
		.attr("fill", "none")
		.attr("stroke", "steelblue")
		.attr("stroke-width", 1)
		.attr("d", d3.line()
			.x( function(d) { return x(new Date(d.date) ); })
			.y( function(d) { return y( +d.new_deaths ); })) ;

	// Set up Interaction
	d3.select("#state")
		.on("change", function(d)
		{
			my_state = document.getElementById("state");
			var sel_state = my_state.value;

			var state_index = states.indexOf( sel_state );

			var counties = counties_by_state[state_index];

			d3.select("#county").selectAll("option").remove();
			d3.select("#county").selectAll("option")
				.data(counties)
				.enter()
				.append("option")
				.attr("value", function(d) { return d; } )
				.text( function(d) { return d; } ) ;

			dispGraphs();
		});

	d3.select("#county")
		.on("change", function(d)
		{
			// Get county level data
			my_state = document.getElementById("state");
			my_county = document.getElementById("county");

			var sel_state = my_state.value;
			var sel_county = my_county.value;
			var state_data = all_data.filter( function(d) { return (d.state == sel_state) ; } )
			var county_data = state_data.filter( function(d) { return (d.county == sel_county) ; } );
			county_data.sort((a,b) => d3.ascending(a.date, b.date));

			x.domain([ new Date(d3.min( county_data, d => d.date )), new Date(d3.max( county_data, d => d.date)) ]);
			y.domain([ 0,	 d3.max( county_data, d => +d.cases) ]);
		  d3.select("#x_axis").call(xAxis);
			d3.select("#y_axis").call(yAxis);

			// Add the paths
			svg.select("#deaths")
				.datum(county_data)
				.attr("fill", "none")
				.attr("stroke", "steelblue")
				.attr("stroke-width", 1)
				.attr("d", d3.line()
					.x( function(d) { return x(new Date(d.date) ); })
					.y( function(d) { return y( +d.deaths ); }))

				svg.select("#cases")
					.datum(county_data)
					.attr("fill", "none")
					.attr("stroke", "steelblue")
					.attr("stroke-width", 1)
					.attr("d", d3.line()
						.x( function(d) { return x(new Date(d.date) ); })
						.y( function(d) { return y( +d.cases ); }))
		});


} );




</script>
</body>
</html>
